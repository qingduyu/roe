(function(){var remoteImage,uploadImage,onlineImage,searchImage;window.onload=function(){initTabs();initAlign();initButtons()};function initTabs(){var e=$G("tabhead").children;for(var t=0;t<e.length;t++){domUtils.on(e[t],"click",function(e){var t=e.target||e.srcElement;setTabFocus(t.getAttribute("data-content-id"))})}var i=editor.selection.getRange().getClosedNode();if(i&&i.tagName&&i.tagName.toLowerCase()=="img"){setTabFocus("remote")}else{setTabFocus("upload")}}function setTabFocus(e){if(!e)return;var t,i,a=$G("tabhead").children;for(t=0;t<a.length;t++){i=a[t].getAttribute("data-content-id");if(i==e){domUtils.addClass(a[t],"focus");domUtils.addClass($G(i),"focus")}else{domUtils.removeClasses(a[t],"focus");domUtils.removeClasses($G(i),"focus")}}switch(e){case"remote":remoteImage=remoteImage||new RemoteImage;break;case"upload":setAlign(editor.getOpt("imageInsertAlign"));uploadImage=uploadImage||new UploadImage("queueList");break;case"online":setAlign(editor.getOpt("imageManagerInsertAlign"));onlineImage=onlineImage||new OnlineImage("imageList");onlineImage.reset();break;case"search":setAlign(editor.getOpt("imageManagerInsertAlign"));searchImage=searchImage||new SearchImage;break}}function initButtons(){dialog.onok=function(){var e=false,t=[],i,a=$G("tabhead").children;for(var s=0;s<a.length;s++){if(domUtils.hasClass(a[s],"focus")){i=a[s].getAttribute("data-content-id");break}}switch(i){case"remote":t=remoteImage.getInsertList();break;case"upload":t=uploadImage.getInsertList();var n=uploadImage.getQueueCount();if(n){$(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,n)+"</span>");return false}break;case"online":t=onlineImage.getInsertList();break;case"search":t=searchImage.getInsertList();e=true;break}if(t){editor.execCommand("insertimage",t);e&&editor.fireEvent("catchRemoteImage")}}}function initAlign(){domUtils.on($G("alignIcon"),"click",function(e){var t=e.target||e.srcElement;if(t.className&&t.className.indexOf("-align")!=-1){setAlign(t.getAttribute("data-align"))}})}function setAlign(e){e=e||"none";var t=$G("alignIcon").children;for(i=0;i<t.length;i++){if(t[i].getAttribute("data-align")==e){domUtils.addClass(t[i],"focus");$G("align").value=t[i].getAttribute("data-align")}else{domUtils.removeClasses(t[i],"focus")}}}function getAlign(){var e=$G("align").value||"none";return e=="none"?"":e}function RemoteImage(e){this.container=utils.isString(e)?document.getElementById(e):e;this.init()}RemoteImage.prototype={init:function(){this.initContainer();this.initEvents()},initContainer:function(){this.dom={url:$G("url"),width:$G("width"),height:$G("height"),border:$G("border"),vhSpace:$G("vhSpace"),title:$G("title"),align:$G("align")};var e=editor.selection.getRange().getClosedNode();if(e){this.setImage(e)}},initEvents:function(){var t=this,i=$G("lock");domUtils.on($G("url"),"keyup",a);domUtils.on($G("border"),"keyup",a);domUtils.on($G("title"),"keyup",a);domUtils.on($G("width"),"keyup",function(){if(i.checked){var e=i.getAttribute("data-proportion");$G("height").value=Math.round(this.value/e)}else{t.updateLocker()}a()});domUtils.on($G("height"),"keyup",function(){if(i.checked){var e=i.getAttribute("data-proportion");$G("width").value=Math.round(this.value*e)}else{t.updateLocker()}a()});domUtils.on($G("lock"),"change",function(){var e=parseInt($G("width").value)/parseInt($G("height").value);i.setAttribute("data-proportion",e)});function a(){t.setPreview()}},updateLocker:function(){var e=$G("width").value,t=$G("height").value,i=$G("lock");if(e&&t&&e==parseInt(e)&&t==parseInt(t)){i.disabled=false;i.title=""}else{i.checked=false;i.disabled="disabled";i.title=lang.remoteLockError}},setImage:function(e){if(!e.tagName||e.tagName.toLowerCase()!="img"&&!e.getAttribute("src")||!e.src)return;var t=e.getAttribute("word_img"),i=t?t.replace("&amp;","&"):e.getAttribute("_src")||e.getAttribute("src",2).replace("&amp;","&"),a=editor.queryCommandValue("imageFloat");if(i!==$G("url").value)$G("url").value=i;if(i){$G("width").value=e.width||"";$G("height").value=e.height||"";$G("border").value=e.getAttribute("border")||"0";$G("vhSpace").value=e.getAttribute("vspace")||"0";$G("title").value=e.title||e.alt||"";setAlign(a);this.setPreview();this.updateLocker()}},getData:function(){var e={};for(var t in this.dom){e[t]=this.dom[t].value}return e},setPreview:function(){var e=$G("url").value,t=$G("width").value,i=$G("height").value,a=$G("border").value,s=$G("title").value,n=$G("preview"),r,o;r=!t||!i?n.offsetWidth:Math.min(t,n.offsetWidth);r=r+a*2>n.offsetWidth?r:n.offsetWidth-a*2;o=!t||!i?"":r*i/t;if(e){n.innerHTML='<img src="'+e+'" width="'+r+'" height="'+o+'" border="'+a+'px solid #000" title="'+s+'" />'}},getInsertList:function(){var e=this.getData();if(e["url"]){return[{src:e["url"],_src:e["url"],width:e["width"]||"",height:e["height"]||"",border:e["border"]||"",floatStyle:e["align"]||"",vspace:e["vhSpace"]||"",alt:e["title"]||"",style:"width:"+e["width"]+"px;height:"+e["height"]+"px;"}]}else{return[]}}};function UploadImage(e){this.$wrap=e.constructor==String?$("#"+e):$(e);this.init()}UploadImage.prototype={init:function(){this.imageList=[];this.initContainer();this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var a=this,d=jQuery,e=a.$wrap,s=e.find(".filelist"),n=e.find(".statusBar"),r=n.find(".info"),o=e.find(".uploadBtn"),t=e.find(".filePickerBtn"),c=e.find(".filePickerBlock"),l=e.find(".placeholder"),u=n.find(".progress").hide(),i=0,g=0,h=window.devicePixelRatio||1,p=113*h,f=113*h,m="",v={},b=function(){var e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;e=null;return t}(),w,I=editor.getActionUrl(editor.getOpt("imageActionName")),C=(editor.getOpt("imageAllowFiles")||[".png",".jpg",".jpeg",".gif",".bmp"]).join("").replace(/\./g,",").replace(/^[,]/,""),x=editor.getOpt("imageMaxSize"),$=editor.getOpt("imageCompressBorder");if(!WebUploader.Uploader.support()){d("#filePickerReady").after(d("<div>").html(lang.errorNotSupport)).hide();return}else if(!editor.getOpt("imageActionName")){d("#filePickerReady").after(d("<div>").html(lang.errorLoadConfig)).hide();return}w=a.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},accept:{title:"Images",extensions:C,mimeTypes:"image/jpeg,image/png,image/svg,image/webp,image/gif"},swf:"../../third-party/webuploader/Uploader.swf",server:I,fileVal:editor.getOpt("imageFieldName"),duplicate:true,fileSingleSizeLimit:x,compress:false});w.addButton({id:"#filePickerBlock"});w.addButton({id:"#filePickerBtn",label:lang.uploadAddFile});L("pedding");function U(i){var a=d('<li id="'+i.id+'">'+'<p class="title">'+i.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),s=d('<div class="file-panel">'+'<span class="cancel">'+lang.uploadDelete+"</span>"+'<span class="rotateRight">'+lang.uploadTurnRight+"</span>"+'<span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(a),n=a.find("p.progress span"),r=a.find("p.imgWrap"),o=d('<p class="error"></p>').hide().appendTo(a),l=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry;break}o.text(text).show()};if(i.getStatus()==="invalid"){l(i.statusText)}else{r.text(lang.uploadPreview);if(browser.ie&&browser.version<=7){r.text(lang.uploadNoPreview)}else{w.makeThumb(i,function(e,t){if(e||!t){r.text(lang.uploadNoPreview)}else{var i=d('<img src="'+t+'">');r.empty().append(i);i.on("error",function(){r.text(lang.uploadNoPreview)})}},p,f)}v[i.id]=[i.size,0];i.rotation=0;if(!i.ext||C.indexOf(i.ext.toLowerCase())==-1){l("not_allow_type");w.removeFile(i)}}i.on("statuschange",function(e,t){if(t==="progress"){n.hide().width(0)}else if(t==="queued"){a.off("mouseenter mouseleave");s.remove()}if(e==="error"||e==="invalid"){l(i.statusText);v[i.id][1]=1}else if(e==="interrupt"){l("interrupt")}else if(e==="queued"){v[i.id][1]=0}else if(e==="progress"){o.hide();n.css("display","block")}else if(e==="complete"){}a.removeClass("state-"+t).addClass("state-"+e)});a.on("mouseenter",function(){s.stop().animate({height:30})});a.on("mouseleave",function(){s.stop().animate({height:0})});s.on("click","span",function(){var e=d(this).index(),t;switch(e){case 0:w.removeFile(i);return;case 1:i.rotation+=90;break;case 2:i.rotation-=90;break}if(b){t="rotate("+i.rotation+"deg)";r.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t})}else{r.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(i.rotation/90%4+4)%4+")")}});a.insertBefore(c)}function k(e){var t=d("#"+e.id);delete v[e.id];G();t.off().find(".file-panel").off().end().remove()}function G(){var i=0,a=0,e=u.children(),t;d.each(v,function(e,t){a+=t[0];i+=t[0]*t[1]});t=a?i/a:0;e.eq(0).text(Math.round(t*100)+"%");e.eq(1).css("width",Math.round(t*100)+"%");y()}function L(e,t){if(e!=m){var i=w.getStats();o.removeClass("state-"+m);o.addClass("state-"+e);switch(e){case"pedding":s.addClass("element-invisible");n.addClass("element-invisible");l.removeClass("element-invisible");u.hide();r.hide();w.refresh();break;case"ready":l.addClass("element-invisible");s.removeClass("element-invisible");n.removeClass("element-invisible");u.hide();r.show();o.text(lang.uploadStart);w.refresh();break;case"uploading":u.show();r.hide();o.text(lang.uploadPause);break;case"paused":u.show();r.hide();o.text(lang.uploadContinue);break;case"confirm":u.show();r.hide();o.text(lang.uploadStart);i=w.getStats();if(i.successNum&&!i.uploadFailNum){L("finish");return}break;case"finish":u.hide();r.show();if(i.uploadFailNum){o.text(lang.uploadRetry)}else{o.text(lang.uploadStart)}break}m=e;y()}if(!a.getQueueCount()){o.addClass("disabled")}else{o.removeClass("disabled")}}function y(){var e="",t;if(m==="ready"){e=lang.updateStatusReady.replace("_",i).replace("_KB",WebUploader.formatSize(g))}else if(m==="confirm"){t=w.getStats();if(t.uploadFailNum){e=lang.updateStatusConfirm.replace("_",t.successNum).replace("_",t.successNum)}}else{t=w.getStats();e=lang.updateStatusFinish.replace("_",i).replace("_KB",WebUploader.formatSize(g)).replace("_",t.successNum);if(t.uploadFailNum){e+=lang.updateStatusError.replace("_",t.uploadFailNum)}}r.html(e)}w.on("fileQueued",function(e){editor.getOpt("imageUploadService")(a,editor).setUploadData(e);i++;g+=e.size;if(i===1){l.addClass("element-invisible");n.show()}U(e)});w.on("fileDequeued",function(e){if(e.ext&&C.indexOf(e.ext.toLowerCase())!=-1&&e.size<=x){i--;g-=e.size}k(e);G()});w.on("filesQueued",function(e){if(!w.isInProgress()&&(m=="pedding"||m=="finish"||m=="confirm"||m=="ready")){L("ready")}G()});w.on("all",function(e,t){switch(e){case"uploadFinished":L("confirm",t);break;case"startUpload":editor.getOpt("imageUploadService")(a,editor).setUploaderOptions(w);L("uploading",t);break;case"stopUpload":L("paused",t);break}});w.on("uploadBeforeSend",function(e,t,i){editor.getOpt("imageUploadService")(a,editor).setFormData(e,t,i)});w.on("uploadProgress",function(e,t){var i=d("#"+e.id),a=i.find(".progress span");a.css("width",t*100+"%");v[e.id][1]=t;G()});w.on("uploadSuccess",function(e,t){var i=d("#"+e.id);try{if(editor.getOpt("imageUploadService")(a,editor).getResponseSuccess(t)){a.imageList.push(t);i.append('<span class="success"></span>')}else{i.find(".error").text(t.message).show()}}catch(e){i.find(".error").text(lang.errorServerUpload).show()}});w.on("uploadError",function(e,t){});w.on("error",function(e,t){if(e=="Q_TYPE_DENIED"||e=="F_EXCEED_SIZE"){U(t)}});w.on("uploadComplete",function(e,t){});o.on("click",function(){if(d(this).hasClass("disabled")){return false}if(m==="ready"){window.setTimeout(function(){w.upload()},500)}else if(m==="paused"){window.setTimeout(function(){w.upload()},500)}else if(m==="uploading"){w.stop()}});o.addClass("state-"+m);G()},getQueueCount:function(){var e,t,i,a=0,s=this.uploader.getFiles();for(t=0;e=s[t++];){i=e.getStatus();if(i=="queued"||i=="uploading"||i=="progress")a++}return a},destroy:function(){this.$wrap.remove()},getInsertList:function(){var e,t,i=[],a=getAlign(),s=editor.getOpt("imageUrlPrefix"),n=editor.getOpt("imageUploadService")(this,editor).imageSrcField||"url";for(e=0;e<this.imageList.length;e++){t=this.imageList[e];i.push({src:s+t[n],_src:s+t[n],alt:t.original,floatStyle:a})}return i}};function OnlineImage(e){this.container=utils.isString(e)?document.getElementById(e):e;this.init()}OnlineImage.prototype={init:function(){this.reset();this.initEvents()},initContainer:function(){this.container.innerHTML="";this.list=document.createElement("ul");this.clearFloat=document.createElement("li");domUtils.addClass(this.list,"list");domUtils.addClass(this.clearFloat,"clearFloat");this.list.appendChild(this.clearFloat);this.container.appendChild(this.list)},initEvents:function(){var i=this;domUtils.on($G("imageList"),"scroll",function(e){var t=this;if(t.scrollHeight-(t.offsetHeight+t.scrollTop)<10){i.getImageData()}});domUtils.on(this.container,"click",function(e){var t=e.target||e.srcElement,i=t.parentNode;if(i.tagName.toLowerCase()=="li"){if(domUtils.hasClass(i,"selected")){domUtils.removeClasses(i,"selected")}else{domUtils.addClass(i,"selected")}}})},initData:function(){this.state=0;this.listSize=editor.getOpt("imageManagerListSize");this.listIndex=0;this.listEnd=false;this.getImageData()},reset:function(){this.initContainer();this.initData()},getImageData:function(){var _this=this;if(!_this.listEnd&&!this.isLoadingData){this.isLoadingData=true;var url=editor.getActionUrl(editor.getOpt("imageManagerActionName")),isJsonp=utils.isCrossDomainUrl(url);ajax.request(url,{timeout:1e5,dataType:isJsonp?"jsonp":"",data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=isJsonp?r:eval("("+r.responseText+")");if(json.state=="SUCCESS"){_this.pushData(json.list);_this.listIndex=parseInt(json.start)+parseInt(json.list.length);if(_this.listIndex>=json.total){_this.listEnd=true}_this.isLoadingData=false}}catch(e){if(r.responseText.indexOf("ue_separate_ue")!=-1){var list=r.responseText.split(r.responseText);_this.pushData(list);_this.listIndex=parseInt(list.length);_this.listEnd=true;_this.isLoadingData=false}}},onerror:function(){_this.isLoadingData=false}})}},pushData:function(e){var t,i,a,s,n=this,r=editor.getOpt("imageManagerUrlPrefix");for(t=0;t<e.length;t++){if(e[t]&&e[t].url){i=document.createElement("li");a=document.createElement("img");s=document.createElement("span");domUtils.on(a,"load",function(e){return function(){n.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)}}(a));a.width=113;a.setAttribute("src",r+e[t].url+(e[t].url.indexOf("?")==-1?"?noCache=":"&noCache=")+(+new Date).toString(36));a.setAttribute("_src",r+e[t].url);domUtils.addClass(s,"icon");i.appendChild(a);i.appendChild(s);this.list.insertBefore(i,this.clearFloat)}}},scale:function(e,t,i,a){var s=e.width,n=e.height;if(a=="justify"){if(s>=n){e.width=t;e.height=i*n/s;e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"}else{e.width=t*s/n;e.height=i;e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"}}else{if(s>=n){e.width=t*s/n;e.height=i;e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"}else{e.width=t;e.height=i*n/s;e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"}}},getInsertList:function(){var e,t=this.list.children,i=[],a=getAlign();for(e=0;e<t.length;e++){if(domUtils.hasClass(t[e],"selected")){var s=t[e].firstChild,n=s.getAttribute("_src");i.push({src:n,_src:n,alt:n.substr(n.lastIndexOf("/")+1),floatStyle:a})}}return i}};function SearchImage(){this.init()}SearchImage.prototype={init:function(){this.initEvents()},initEvents:function(){var t=this;domUtils.on($G("searchBtn"),"click",function(){var e=$G("searchTxt").value;if(e&&e!=lang.searchRemind){t.getImageData()}});domUtils.on($G("searchReset"),"click",function(){$G("searchTxt").value=lang.searchRemind;$G("searchListUl").innerHTML="";$G("searchType").selectedIndex=0});domUtils.on($G("searchTxt"),"focus",function(){var e=$G("searchTxt").value;if(e&&e==lang.searchRemind){$G("searchTxt").value=""}});domUtils.on($G("searchTxt"),"keydown",function(e){var t=e.keyCode||e.which;if(t==13){$G("searchBtn").click()}});domUtils.on($G("searchList"),"click",function(e){var t=e.target||e.srcElement,i=t.parentNode.parentNode;if(i.tagName.toLowerCase()=="li"){if(domUtils.hasClass(i,"selected")){domUtils.removeClasses(i,"selected")}else{domUtils.addClass(i,"selected")}}})},scale:function(e,t,i){var a=e.width,s=e.height;if(a>=s){e.width=t*a/s;e.height=i;e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"}else{e.width=t;e.height=i*s/a;e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"}},getImageData:function(){var a=this,e=$G("searchTxt").value,t=$G("searchType").value,i=editor.options.keepOriginName?"1":"0",s=$G("pageNum").value,n="https://image.baidu.com/search/acjson?tn=resultjson_com&ipn=rj&ct=201326592&is=&fp=result&queryWord="+e+"&cl=2"+t+"&ie=utf-8&oe=utf-8&adpicid=&z=&ic=0&word="+e+"&se=&tab=&width=&height=&istype=2&qc=&nc=1&fr=&pn=60&rn="+s+"&gsm=78&"+new Date+"=";$G("searchListUl").innerHTML=lang.searchLoading;ajax.request(n,{dataType:"jsonp",onsuccess:function(e){var t=[];if(e&&e.data){for(var i=0;i<e.data.length;i++){if(e.data[i].objURL){t.push({title:e.data[i].fromPageTitleEnc,src:e.data[i].thumbURL,url:e.data[i].thumbURL})}}}a.setList(t)},onerror:function(){$G("searchListUl").innerHTML=lang.searchRetry}})},setList:function(e){var t,i,a,s,n,r=this,o=$G("searchListUl");o.innerHTML="";if(e.length){for(t=0;t<e.length;t++){i=document.createElement("li");a=document.createElement("p");s=document.createElement("img");n=document.createElement("a");s.onload=function(){r.scale(this,113,113)};s.width=113;s.setAttribute("src",e[t].src);n.href=e[t].url;n.target="_blank";n.title=e[t].title;n.innerHTML=e[t].title;a.appendChild(s);i.appendChild(a);i.appendChild(n);o.appendChild(i)}}else{o.innerHTML=lang.searchRetry}},getInsertList:function(){var e,t,i=getAlign(),a=[],s=$G("searchListUl").children;for(var n=0;n<s.length;n++){e=s[n].firstChild&&s[n].firstChild.firstChild;if(e.tagName&&e.tagName.toLowerCase()=="img"&&domUtils.hasClass(s[n],"selected")){t=e.src;a.push({src:t,_src:t,alt:t.substr(t.lastIndexOf("/")+1),floatStyle:i})}}return a}}})();